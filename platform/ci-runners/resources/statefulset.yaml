apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ci-runner
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: ci-runner
  serviceName: ci-runner
  replicas: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ci-runner
    spec:
      runtimeClassName: kata
      # source: https://docs.cilium.io/en/latest/network/kubernetes/kata/
      initContainers:
        - name: set-mtu
          # renovate: datasource=docker
          image: busybox:1.37.0
          command:
            - sh
            - -c
            - |
              GW="$(ip route show default | awk 'NR==1 {print $3}')"
              DEV="$(ip route show default | awk 'NR==1 {print $5}')"
              ip route replace default via "$GW" dev "$DEV" mtu 1450
          securityContext:
            privileged: true
            runAsUser: 0
            capabilities:
              add:
                - NET_ADMIN
      containers:
        - name: runner
          image: ghcr.io/pando85/forgejo-runner:12.6.4@sha256:3569c1887f7bdca8619e09853eec02422e09ff0249a413a71368c6a5f0db8046
          command:
            - sh
            - -c
            - |
              while ! nc -z localhost 2376 </dev/null; do
                echo 'waiting for docker daemon...'
                sleep 5
              done

              cp /config/.runner .
              exec forgejo-runner -c /registration/registration.yaml daemon
          resources:
            requests:
              memory: "100Mi"
              cpu: "100m"
            limits:
              memory: "10Gi"
              cpu: "12"
          securityContext:
            privileged: true
            runAsUser: 1001
          env:
            - name: DOCKER_HOST
              value: tcp://localhost:2376
            - name: DOCKER_CERT_PATH
              value: /certs/client
            - name: DOCKER_TLS_VERIFY
              value: "1"
          volumeMounts:
            - name: docker-certs
              mountPath: /certs
            - name: runner-data
              mountPath: /workspace
            - name: runner-registration
              mountPath: /registration
              readOnly: false
            - name: runner-config
              mountPath: /config
              readOnly: false
            - name: ci-runner-cache
              mountPath: /cache
        - name: daemon
          # renovate: datasource=docker
          image: docker:29.2.1
          # finish the docker daemon when the main container exits
          command:
            - sh
            - -c
            - |
              if [[ $(df -PT /var/lib/docker | awk 'NR==2 {print $2}') == virtiofs ]]; then
                truncate -s 50G /docker/disk.img &&
                mkfs.ext4 /docker/disk.img &&
                mount /docker/disk.img /var/lib/docker;
              fi &&
              dockerd-entrypoint.sh 2>&1 &
              while pgrep forgejo-runner > /dev/null && pgrep dockerd > /dev/null; do
                echo "watching main job execution and docker daemon"
                sleep 60
              done;

              echo "one of the processes exited, stopping dind"
              exit 0
          env:
            - name: DOCKER_TLS_CERTDIR
              value: /certs
            - name: DOCKER_HOST
              value: tcp://0.0.0.0:2376
          securityContext:
            privileged: true
            runAsUser: 0
          volumeMounts:
            - name: docker-certs
              mountPath: /certs
            - name: ci-runner-docker
              mountPath: /docker
            - name: runner-data
              mountPath: /workspace
            - name: ci-runner-cache
              mountPath: /cache
          resources:
            requests:
              memory: "100Mi"
              cpu: "100m"
            limits:
              memory: "5Gi"
              cpu: "3"
      securityContext:
        privileged: true
        fsGroup: 1001
        runAsGroup: 1001
        runAsUser: 1001
      volumes:
        - name: runner-data
          emptyDir:
            medium: Memory
            sizeLimit: 3Gi
        - name: runner-config
          secret:
            secretName: runner-config
        - name: runner-registration
          configMap:
            name: runner-registration
        - name: docker-certs
          emptyDir: {}
        - name: ci-runner-cache
          persistentVolumeClaim:
            claimName: ci-runner-cache
        - name: ci-runner-docker
          persistentVolumeClaim:
            claimName: ci-runner-docker
      # not working with kata runtime
      #resources:
      #  requests:
      #    memory: "100Mi"
      #    cpu: "100m"
      #  limits:
      #    memory: "15Gi"
      #    cpu: "8"
      restartPolicy: Always
      shareProcessNamespace: true
