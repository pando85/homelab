---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: kanidm-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault
  target:
    name: kanidm-config
    template:
      engineVersion: v2
      data:
        server.toml: |
          bindaddress = "0.0.0.0:8443"
          ldapbindaddress = "0.0.0.0:3636"
          trust_x_forward_for = true
          db_path = "/data/kanidm.db"
          db_fs_type = "zfs"
          tls_chain = "/data/tls/tls.crt"
          tls_key = "/data/tls/tls.key"
          log_level = "info"
          domain = "idm.grigri.cloud"
          origin = "https://idm.grigri.cloud"
          role = "WriteReplica"

          [online_backup]
          path = "/data/kanidm/backups/"
          schedule = "00 2 * * *"
          versions = 1

          [replication]
          origin = "repl://kanidm-kanidmd:8444"
          bindaddress = "0.0.0.0:8444"

          [replication."repl://kanidm-default-0.kanidm:8444"]
          type = "allow-pull"
          consumer_cert = {{`"{{ .cert }}"`}}

  data:
    - secretKey: cert
      remoteRef:
        key: /kanidm/kanidm-default-0-certificate
        property: tls.der.b64url
