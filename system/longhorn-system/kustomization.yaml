apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
  - includeCRDs: true
    name: longhorn
    namespace: longhorn-system
    releaseName: longhorn-system
    repo: https://charts.longhorn.io
    valuesFile: values.yaml
    version: 1.4.0

resources:
  - resources/backup-postgres-recurrent-job.yaml
  - resources/backup-recurrent-job.yaml
  - resources/longhorn-rules.yaml
  - resources/minio-secret.yaml
  - resources/no-backup.yaml
  - resources/servicemonitor.yaml
  - resources/snapshot-postgres-recurrent-job.yaml
  - resources/snapshot-recurrent-job.yaml
  - resources/ssd-storage-class.yaml

patchesJson6902:
  - target:
      kind: ConfigMap
      name: longhorn-storageclass
      namespace: longhorn-system
      version: v1
    patch: |-
      - op: replace
        path: "/data/storageclass.yaml"
        value: |
          kind: StorageClass
          apiVersion: storage.k8s.io/v1
          metadata:
            name: longhorn
            annotations:
              storageclass.kubernetes.io/is-default-class: "true"
          provisioner: driver.longhorn.io
          allowVolumeExpansion: true
          reclaimPolicy: "Delete"
          volumeBindingMode: Immediate
          parameters:
            numberOfReplicas: "2"
            staleReplicaTimeout: "30"
            fromBackup: ""
            fsType: "ext4"
            dataLocality: "disabled"
            diskSelector: "hdd"
  - target:
      version: v1
      kind: DaemonSet
      name: longhorn-manager
      namespace: longhorn-system
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: 64Mi
