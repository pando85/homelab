apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: immich-postgres
  labels:
    backup/retain: quaterly
spec:
  teamId: immich
  # renovate: datasource=docker versioning=regex:^(?<major>\d+)\.(?<minor>\d+)-p(?<patch>\d+)$
  dockerImage: ghcr.io/pando85/spilo-17-vchord:4.0-p3
  numberOfInstances: 1

  resources:
    requests:
      cpu: 10m
      memory: 128Mi
    limits:
      memory: 1Gi

  volume:
    # for storing 3 months of snapshots
    size: 10Gi

  users:
    immich:
      - superuser
      - createdb
  databases:
    immich: immich

  postgresql:
    version: "17"
    parameters:
      archive_mode: "off"
      max_connections: "25"
      shared_buffers: "256MB"
      work_mem: "16MB"
      random_page_cost: "1.1"
      effective_io_concurrency: "20"
      checkpoint_completion_target: "0.9"
      # Don't wait for HDD sync on each commit
      synchronous_commit: "off"
      wal_writer_delay: "100ms"
      log_checkpoints: "off"
      log_connections: "off"
      log_disconnections: "off"
      log_lock_waits: "off"
      log_min_duration_statement: "-1"
      log_statement: none
      # add vectors.so to shared_preload_libraries
      shared_preload_libraries: "bg_mon,pg_stat_statements,pgextwlist,pg_auth_mon,set_user,timescaledb,pg_cron,pg_stat_kcache,vchord.so"
      # ZFS settings because recordsize is 128k not 8k
      full_page_writes: "on"

  # preparedDatabases:
  #   immich:
  #     extensions:
  #     # it doesn't work. Manually applied:
  #     # ```sql
  #     # CREATE EXTENSION IF NOT EXISTS cube;
  #     # CREATE EXTENSION IF NOT EXISTS earthdistance;
  #     # ALTER SYSTEM SET shared_preload_libraries = "vchord.so"
  #     # CREATE EXTENSION IF NOT EXISTS vchord CASCADE;
  #     # ```
  #       cube: public
  #       earthdistance: public
  #       vchord: public
