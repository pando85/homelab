apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: pt-postgres
  labels:
    backup/retain: weekly
spec:
  teamId: pt

  numberOfInstances: 1

  resources:
    requests:
      cpu: 10m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - prusik

  enableMasterLoadBalancer: true
  masterServiceAnnotations:
    lbipam.cilium.io/ips: "192.168.193.5"
    external-dns.alpha.kubernetes.io/enabled: "true"
  allowedSourceRanges:
    - 0.0.0.0/0
  volume:
    size: 500Mi

  users:
    pt:
      - superuser
      - createdb
  databases:
    pt: pt

  patroni:
    pg_hba:
      - local   all             all                                   trust
      - hostssl all             +zalandos    127.0.0.1/32       pam
      - host    all             all                127.0.0.1/32       md5
      - hostssl all             +zalandos    ::1/128            pam
      - host    all             all                ::1/128            md5
      - local   replication     standby                    trust
      - hostssl replication     standby all                md5
      - hostssl all             +zalandos    all                pam
      - hostssl all             all                all                md5
      - hostssl all             all all md5
      - host    all             all all md5
  postgresql:
    version: "16"
    parameters:
      archive_mode: "off"
      # minimal value. If not default to 100
      max_connections: "25"
      shared_buffers: 32MB
      log_checkpoints: "off"
      log_connections: "off"
      log_disconnections: "off"
      log_lock_waits: "off"
      log_min_duration_statement: "-1"
      log_statement: none
      # ZFS settings:
      full_page_writes: "off"
